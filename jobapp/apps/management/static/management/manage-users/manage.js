$(document).ready(function () {
  const userTable = $("#user-table").DataTable({
    lengthMenu: [], // Remove the entries per page dropdown
    buttons: ["pdf"],
    dom: "Bfrtip",
    buttons: [
      {
        extend: "pdf",
        exportOptions: {
          // starting index is 0
          columns: [1, 2, 3, 4], // Exclude columns with class 'exclude-print'],
        },

        title: "List of Users",
        customize: function (doc) {
          // get the name column data
          const nameArray = ["header", ...userTable.column(1).data().toArray()];

          var columnIndex = 0; // Index of the second column
          let tableBody1 = doc.content[1].table.body; // Get the body of the table in the document

          // Modify the content of the second column in the exported PDF document
          tableBody1.forEach(function (row, idx) {
            if (idx === 0) return; //Skip the first row (header)
            row[columnIndex].text = nameArray[idx]; // Replace the content with values from the nameArray
          });

          // change table header background color
          doc.content[1].table.headerRows = 1;
          doc.content[1].table.widths = Array(
            doc.content[1].table.body[0].length
          ).fill("auto");
          doc.content[1].table.body[0].forEach(function (column, index) {
            column.fillColor = "#386641";
          });

          //set specific widths for the columns
          doc.content[1].table.widths = ["*", "*", "15%", "15%"];

          // align table header to left
          const header = doc.content[1].table.body[0];
          header.forEach((cell) => {
            cell.alignment = "left";
          });

          // add margin to each cell
          const tableBody = doc.content[1].table.body;
          tableBody.forEach((row) => {
            row.forEach((cell) => {
              cell.margin = [5, 5, 5, 5];
            });
          });

          // footer
          doc.footer = function (page, pages) {
            return {
              text: [
                { text: `Generated by: ${generatedBy}\n`, alignment: "left" },
                {
                  text:
                    "Date Generated: " +
                    new Date().toLocaleString("en-US", {
                      month: "long",
                      day: "2-digit",
                      year: "numeric",
                      hour: "numeric",
                      minute: "numeric",
                      hour12: true,
                    }),
                  alignment: "left",
                },
              ],
              margin: [40, 0],
              fontSize: 10,
            };
          };
        },
      },
    ],
    columnDefs: [
      { targets: 0, visible: false },
      { targets: 2, visible: false },
      {
        targets: 1,
        render: function (data, type, row) {
          // render the name column as a combination of avatar, name and email
          return `
          <div class="flex flex-row gap-2">
          ${row[0]}
            <div>
                ${row[1]}
                <div class="exclude-print">${row[2]}</div>
            </div>
          </div>`;
        },
      },
    ],
  });

  $("#pdfBtn").on("click", function () {
    userTable.button(".buttons-html5").trigger();
  });

  $("#usersSearchField").keyup(function () {
    userTable.search($(this).val()).draw();
  });
});
