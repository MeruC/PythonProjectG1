$(document).ready(function () {
  const historyTable = $("#history-table").DataTable({
    lengthMenu: [], // Remove the entries per page dropdown
    language: {
      lengthMenu: " ", // Hide the "Show [X] entries" text
    },
    buttons: [
      {
        extend: "pdf",
        download: "open",
        exportOptions: {
          // starting index is 0
          columns: [0, 1, 2, 3],
        },

        title: `${full_name}'s Job Application History`,
        customize: function (doc) {
          // change table header background color
          doc.content[1].table.headerRows = 1;
          doc.content[1].table.widths = Array(
            doc.content[1].table.body[0].length
          ).fill("auto");
          doc.content[1].table.body[0].forEach(function (column, index) {
            column.fillColor = "#386641";
          });

          //set specific widths for the columns
          doc.content[1].table.widths = ["30%", "20%", "20%", "30%"];

          // align table header to left
          const header = doc.content[1].table.body[0];
          header.forEach((cell) => {
            cell.alignment = "left";
          });

          const rowCount = doc.content[1].table.body.length - 1;
          doc.content.push({
            text: `Total: ${rowCount}`,
            alignment: "left",
            margin: [5, 10],
          });

          // add margin to each cell
          const tableBody = doc.content[1].table.body;

          tableBody.forEach((row) => {
            row.forEach((cell) => {
              cell.margin = [5, 5, 5, 5];
            });
          });

          // footer
          doc.footer = function (page, pages) {
            return {
              text: [
                { text: `Generated by: ${generatedBy}\n`, alignment: "left" },
                {
                  text:
                    "Date Generated: " +
                    new Date().toLocaleString("en-US", {
                      month: "long",
                      day: "2-digit",
                      year: "numeric",
                      hour: "numeric",
                      minute: "numeric",
                      hour12: true,
                    }),
                  alignment: "left",
                },
                { text: `\n${page}`, alignment: "right" },
              ],
              margin: [40, 0],
              fontSize: 10,
            };
          };
        },
      },
    ],
    dom: "Bfrtip",
  });

  $("#history-table").on("click", ".historyDeleteBtn", function () {
    // get the data id
    const id = $(this).data("id");
    const companyName = $(this).data("company");
    const jobTitle = $(this).data("job");

    console.log(id, companyName, jobTitle);
    Swal.fire({
      title: "Remove?",
      text: `Are you sure you want to remove their application for ${companyName} as a ${jobTitle}?`,
      icon: "warning",
      confirmButtonText: "Remove Application",
      confirmButtonColor: "#EF5350",
      showCancelButton: true,
      showCloseButton: false,
    }).then((result) => {
      if (result.isConfirmed) {
        window.location.href = `history/${id.toString().trim()}/delete`;
      }
    });
  });

  $("#applicationSearchField").keyup(function () {
    historyTable.search($(this).val()).draw();
  });

  $("#applicationPdfBtn").click(function () {
    historyTable.button(".buttons-html5").trigger();
  });
});
